#!/bin/bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "$0")/.."; pwd)"
CIRCLECI_IMAGE='docker.pkg.github.com/dena/unity-meta-check/unity-meta-check-circleci'
IMAGE='docker.pkg.github.com/dena/unity-meta-check/unity-meta-check-v2'


usage() {
	cat - 1>&2 <<-EOS
usage: build-image [<options>]

OPTIONS
	-h, --help    print this usage
	--latest      also tag as latest
EOS
}


main() {
	local arg="${1:-}"
	if [[ "$arg" == "-h" || "$arg" == "--help" || "$arg" == "help" ]]; then
		usage
		false
	fi

	(cd "$BASE_DIR"
		local version
		version="$("$BASE_DIR/scripts/print-version")"

		docker build -t "$IMAGE:$version" -f ./Dockerfile .
		if [[ "$arg" == "--latest" ]]; then
			docker tag "$IMAGE:$version" "$IMAGE:latest"
		fi

		docker build -t "$CIRCLECI_IMAGE:$version" -f ./.circleci/images/Dockerfile .
		if [[ "$arg" == "--latest" ]]; then
			docker tag "$CIRCLECI_IMAGE:$version" "$CIRCLECI_IMAGE:latest"
		fi
	)
}


main "$@"
